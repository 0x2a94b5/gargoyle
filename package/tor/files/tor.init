#!/bin/sh /etc/rc.common
# Copyright (C) 2006 OpenWrt.org
START=50

BIN=tor
VAR_D=/etc/$BIN/var
RUN_D=/var/run
PID_F=$RUN_D/$BIN.pid
RUN_USER=root
RUN_GROUP=root
OPTIONS=" --User $RUN_USER  --ClientOnly 1 --PidFile '$PID_F' --RunAsDaemon 1 --DataDirectory '/var/tor' --Log 'warn syslog' "



start()
{
	enabled=$(uci get tor.global.enabled)
	if [ "$enabled" = "0" ] ; then
		exit
	fi

        [ -d $VAR_D ] || ( mkdir -m 0700 -p $VAR_D && chown $RUN_USER:$RUN_GROUP $VAR_D )
	[ -d $RUN_D ] || mkdir -p $RUN_D
	[ -f $PID_F ] || ( touch $PID_F && chown $RUN_USER:$RUN_GROUP $PID_F )
	
	zone=$( uci get tor.global.zone                 2>/dev/null)
	socks_port=$( uci get tor.global.socks_port     2>/dev/null)
	dns_port=$( uci get tor.global.dns_port         2>/dev/null)
	control_port=$( uci get tor.global.control_port 2>/dev/null)
	if [ -z "$zone" ] ; then
		zone="lan"
	fi
	if [ -z "$socks_port" ] ; then
		socks_port=9050
	fi
	if [ -z "$dns_port" ] ; then
		dns_port=9053
	fi
	if [ -z "$control_port" ] ; then
		control_port=9051
	fi



	OPTIONS="$OPTIONS --SocksPort $socks_port --DNSPort $dns_port --ControlPort $control_port "
	listen_ip=$(uci -P /var/state/network get network.$zone.ipaddr 2>/dev/null)
	if [ -n "$listen_ip" ] ; then
		OPTIONS="$OPTIONS --SocksListenAddress '$listen_ip' --DNSListenAddress '$listen_ip' "
	fi

	
	eval $BIN $OPTIONS
}

stop() {
	[ -f $PID_F ] && kill $(cat $PID_F)
}

